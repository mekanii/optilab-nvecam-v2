<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link href="./assets/css/bootstrap.min.css" rel="stylesheet" >
  <link href="./assets/css/datepicker.min.css" rel="stylesheet" >
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Arial', sans-serif;
    }
    #message {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      text-align: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      color: white;
      pointer-events: none;
      padding: 20px;
      box-sizing: border-box;
      text-shadow: 0 0 5px black;
    }
  </style>
  <script defer src="./reader.js"></script>
</head>

<body>
  <div class="container-fluid">
    <div class="row justify-content-center mt-3 gy-3">
      <div class="col-sm-12 col-md-4 col-lg-3">
        <div class="form-floating">
          <input class="form-control" id="nomor" placeholder="Nomor RM">
          <label for="nomor">Nomor RM</label>
        </div>
      </div>
      <div class="col-sm-12 col-md-4 col-lg-3">
        <div class="form-floating">
          <input class="form-control datepicker_input" id="tgl_lahir" placeholder="yyyy/mm/dd">
          <label for="tgl_lahir">Tanggal Lahir</label>
        </div>
      </div>
      <div class="col-sm-12 col-md-4 col-lg-2">
        <button type="button" id="capture" class="btn btn-primary btn-lg w-100 h-100">Capture</button>  
      </div>
    </div>
    <div class="row justify-content-center mt-3">
      <div class="col-md-12 col-lg-8">
        <div class="ratio ratio-4x3">
          <video id="video" class="w-100 h-100" style="background: rgb(30, 30, 30)"></video>
          <div id="message"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="./assets/js/bootstrap.bundle.min.js"></script>
  <script src="./assets/js/datepicker.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const message = document.getElementById('message');
    let defaultControls = false;

    const setMessage = (str) => {
      if (str !== '') {
        video.controls = false;
      } else {
        video.controls = defaultControls;
      }
      message.innerText = str;
    };

    const parseBoolString = (str, defaultVal) => {
      str = (str || '');

      if (['1', 'yes', 'true'].includes(str.toLowerCase())) {
        return true;
      }
      if (['0', 'no', 'false'].includes(str.toLowerCase())) {
        return false;
      }
      return defaultVal;
    };

    const loadAttributesFromQuery = () => {
      const params = new URLSearchParams(window.location.search);
      video.controls = parseBoolString(params.get('controls'), true);
      video.muted = parseBoolString(params.get('muted'), true);
      video.autoplay = parseBoolString(params.get('autoplay'), true);
      video.playsInline = parseBoolString(params.get('playsinline'), true);
      defaultControls = video.controls;
    };

    window.addEventListener('DOMContentLoaded', () => {
      loadAttributesFromQuery();

      new MediaMTXWebRTCReader({
        url: new URL('whep', window.location.href) + window.location.search,
        onError: (err) => {
          setMessage(err);
        },
        onTrack: (evt) => {
          setMessage('');
          video.srcObject = evt.streams[0];
        },
      });
    });

    /* Bootstrap 5 JS included */
    /* vanillajs-datepicker 1.1.4 JS included */

    const getDatePickerTitle = elem => {
      // From the label or the aria-label
      const label = elem.nextElementSibling;
      let titleText = '';
      if (label && label.tagName === 'LABEL') {
        titleText = label.textContent;
      } else {
        titleText = elem.getAttribute('aria-label') || '';
      }
      return titleText;
    }

    const elems = document.querySelectorAll('.datepicker_input');
    for (const elem of elems) {
      const datepicker = new Datepicker(elem, {
        format: 'yyyy/mm/dd',
        title: getDatePickerTitle(elem),
        autohide: true
      });
    }     

  </script>

</body>
</html>